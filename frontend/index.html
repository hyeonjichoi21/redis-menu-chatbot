<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë°°ë¯¼ ë©”ë‰´ ì¶”ì²œ ì±—ë´‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }

    body {
      background-color: #f4f5f7;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .chat-wrapper {
      width: 100%;
      max-width: 480px;
      height: 80vh;
      background-color: #ffffff;
      border-radius: 24px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background-color: #2ac1bc; /* ë°°ë¯¼ ë¯¼íŠ¸ìƒ‰ ëŠë‚Œ */
      color: #ffffff;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-header-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background-color: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .chat-header-text {
      display: flex;
      flex-direction: column;
    }

    .chat-header-title {
      font-weight: 700;
      font-size: 16px;
    }

    .chat-header-sub {
      font-size: 11px;
      opacity: 0.9;
    }

    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: linear-gradient(to bottom, #f8fafc, #ffffff);
    }

    .chat-bubble {
      max-width: 80%;
      padding: 10px 12px;
      border-radius: 16px;
      margin-bottom: 10px;
      font-size: 14px;
      line-height: 1.4;
      word-break: keep-all;
      white-space: pre-wrap;
    }

    .chat-bubble.user {
      margin-left: auto;
      background-color: #2ac1bc;
      color: #ffffff;
      border-bottom-right-radius: 4px;
    }

    .chat-bubble.bot {
      margin-right: auto;
      background-color: #f1f5f9;
      color: #111827;
      border-bottom-left-radius: 4px;
    }

    .chat-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .chat-input-area {
      border-top: 1px solid #e5e7eb;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background-color: #f9fafb;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      outline: none;
      font-size: 14px;
    }

    .chat-input:focus {
      border-color: #2ac1bc;
      box-shadow: 0 0 0 1px rgba(42, 193, 188, 0.3);
    }

    .chat-button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background-color: #2ac1bc;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.1s ease, opacity 0.1s ease;
      white-space: nowrap;
    }

    .chat-button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      opacity: 0.9;
    }

    .chat-input-row-sub {
      display: flex;
      gap: 6px;
      font-size: 11px;
    }

    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      color: #6b7280;
      cursor: pointer;
      background-color: #ffffff;
    }

    .chip:hover {
      border-color: #2ac1bc;
      color: #111827;
    }

    .status {
      font-size: 11px;
      color: #9ca3af;
      margin-left: 2px;
    }
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <div class="chat-header">
      <div class="chat-header-icon">ğŸ²</div>
      <div class="chat-header-text">
        <div class="chat-header-title">ì˜¤ëŠ˜ ë­ ë¨¹ì§€? ì±—ë´‡</div>
        <div class="chat-header-sub">ê¸°ë¶„ Â· ë‚ ì”¨ Â· ì‹œê°„ëŒ€ì— ë§ëŠ” ë©”ë‰´ ì¶”ì²œ</div>
      </div>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="chat-bubble bot">
        ì•ˆë…•í•˜ì„¸ìš”! ë°°ë‹¬ì˜ë¯¼ì¡± ë©”ë‰´ ì¶”ì²œ ì±—ë´‡ì…ë‹ˆë‹¤ ğŸ˜Š<br />
        ë¨¹ê³  ì‹¶ì€ ë¶„ìœ„ê¸°ë‚˜ ìŒì‹ í‚¤ì›Œë“œë¥¼ í¸í•˜ê²Œ ë§í•´ ì£¼ì„¸ìš”.<br />
        ì˜ˆ) "ë§¤ìš´ êµ­ë¬¼ ìš”ë¦¬", "ì•¼ì‹ìœ¼ë¡œ ê°€ë³ê²Œ", "ë¹„ ì˜¤ëŠ” ë‚  ì–´ìš¸ë¦¬ëŠ” ë©”ë‰´"
      </div>
    </div>
    <div class="chat-input-area">
      <div class="chat-input-row">
        <input
          type="text"
          class="chat-input"
          id="message-input"
          placeholder="ì˜ˆ) ë§¤ìš´ ê±° ë•¡ê¸°ëŠ”ë° êµ­ë¬¼ ë§ê³  ë³¶ìŒìœ¼ë¡œ ì¶”ì²œí•´ì¤˜"
        />
        <button class="chat-button" id="send-button">ë³´ë‚´ê¸°</button>
      </div>
      <div class="chat-input-row-sub">
        <span class="chip" data-preset="ë§¤ìš´ êµ­ë¬¼ ìš”ë¦¬ ì¶”ì²œí•´ì¤˜">ğŸŒ¶ ë§¤ìš´ êµ­ë¬¼</span>
        <span class="chip" data-preset="ì•¼ì‹ìœ¼ë¡œ ë„ˆë¬´ ë¬´ê²ì§€ ì•Šì€ ë©”ë‰´ ì¶”ì²œí•´ì¤˜">ğŸŒ™ ì•¼ì‹</span>
        <span class="chip" data-preset="ë¹„ ì˜¤ëŠ” ë‚  ì–´ìš¸ë¦¬ëŠ” ë©”ë‰´ ì¶”ì²œí•´ì¤˜">â˜” ë¹„ ì˜¤ëŠ” ë‚ </span>
        <span class="status" id="status-text"></span>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000"; // ë°±ì—”ë“œ ì£¼ì†Œ
    const messagesEl = document.getElementById("chat-messages");
    const inputEl = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-button");
    const statusEl = document.getElementById("status-text");
    const chips = document.querySelectorAll(".chip");

    const USER_ID = "demo-user-1"; // ì„ì‹œ ê³ ì • ID (ë‚˜ì¤‘ì— ë³€ê²½ ê°€ëŠ¥)

    function appendMessage(role, text, isStreaming = false) {
      const bubble = document.createElement("div");
      bubble.classList.add("chat-bubble", role === "user" ? "user" : "bot");
      bubble.textContent = text;
      messagesEl.appendChild(bubble);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      if (isStreaming) {
        return bubble;
      }
    }

    async function sendMessage() {
      const message = inputEl.value.trim();
      if (!message) return;

      // ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸”
      appendMessage("user", message);
      inputEl.value = "";

      // ìƒíƒœ í…ìŠ¤íŠ¸
      statusEl.textContent = "ë©”ë‰´ ê³ ë¯¼ ì¤‘... ğŸ½";

      // ë´‡ ë²„ë¸” ë¯¸ë¦¬ í•˜ë‚˜ ë§Œë“¤ì–´ë‘ê³  ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ì±„ìš°ê¸°
      const botBubble = appendMessage("bot", "", true);

      try {
        const response = await fetch(`${API_BASE}/chat/stream`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            user_id: USER_ID,
            message: message,
            mood: null,
            weather: null,
            time_of_day: null,
          }),
        });

        if (!response.body) {
          botBubble.textContent = "ìŠ¤íŠ¸ë¦¬ë°ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.";
          statusEl.textContent = "";
          return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let botText = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });

          // ì„œë²„ì—ì„œ SSE í˜•ì‹(data: ...)ìœ¼ë¡œ ì˜¨ë‹¤ê³  ê°€ì •í•˜ë©´, ì¤„ ë‹¨ìœ„ë¡œ íŒŒì‹±
          const lines = chunk.split("\n");
          for (const line of lines) {
            if (line.startsWith("data:")) {
              const token = line.replace("data:", "").trim();
              botText += token;
              botBubble.textContent = botText;
              messagesEl.scrollTop = messagesEl.scrollHeight;
            }
          }
        }
      } catch (e) {
        botBubble.textContent = "ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
      } finally {
        statusEl.textContent = "";
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    chips.forEach((chip) => {
      chip.addEventListener("click", () => {
        inputEl.value = chip.dataset.preset;
        inputEl.focus();
      });
    });
  </script>
</body>
</html>
